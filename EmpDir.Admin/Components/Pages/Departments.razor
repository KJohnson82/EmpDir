@page "/Departments"
@inject IDbContextFactory<AppDbContext> DbContextFactory

<RequireAuth>
    <PageHeader PageTitle="Departments" CardIcon="@CustomIcons.Domain" />

    @* Departments grid with full CRUD capabilities *@
    <TelerikGrid Data="@departments"
                 Pageable="true"
                 PageSize="15"
                 Sortable="true"
                 SortMode="@SortMode.Single"
                 Size="@ThemeConstants.Grid.Size.Small"
                 Resizable="true"
                 Groupable="true"
                 SelectionMode="GridSelectionMode.Single"
                 AutoGenerateColumns="false"
                 Class="grid-text"
                 EditMode="@GridEditMode.Popup"
                 OnUpdate="@Update"
                 OnCreate="@Add"
                 OnDelete="@Delete"
                 OnRowRender="@OnDepartmentRowRender"
                 ConfirmDelete="true">

        <GridSettings>
            <GridPopupEditSettings MaxHeight="700px"
                                   MaxWidth="700px"
                                   Title="Edit Department"></GridPopupEditSettings>
            <GridPopupEditFormSettings Columns="2"
                                       ColumnSpacing="15px"
                                       Orientation="@FormOrientation.Horizontal"
                                       ButtonsLayout="FormButtonsLayout.End">
            </GridPopupEditFormSettings>
        </GridSettings>

        <GridToolBarTemplate>
            <GridSearchBox Placeholder="Search..."
                           DebounceDelay="300"
                           Fields="@SearchableFields"></GridSearchBox>
            <GridCommandButton Command="Add" Icon="SvgIcon.Plus">Add</GridCommandButton>
        </GridToolBarTemplate>

        <GridColumns>
            <GridColumn Field="DeptName" Title="Department Name" Sortable="true" />

            @* Department location with dropdown editor *@
            <GridColumn Field="@nameof(Department.Location)" Title="Department Location">
                <Template>
                    @{
                        var department = (Department)context;
                        var locationName = locations.FirstOrDefault(l => l.Id == department.Location)?.LocName;
                    }
                    @locationName
                </Template>
                <EditorTemplate>
                    @{
                        var department = (Department)context;
                    }
                    <TelerikDropDownList Data="@locations"
                                         @bind-Value="@department.Location"
                                         ValueField="Id"
                                         TextField="LocName"
                                         AdaptiveMode="AdaptiveMode.Auto" />
                </EditorTemplate>
            </GridColumn>

            <GridColumn Field="DeptManager" Title="Department Manager" Sortable="false" />
            <GridColumn Field="DeptPhone" Title="Phone#" Sortable="false" />
            <GridColumn Field="DeptEmail" Title="Email" Sortable="false" />
            <GridColumn Field="DeptFax" Title="Fax" Sortable="false" Visible="false" />

            @* Active/Inactive status badge *@
            <GridColumn Field="@nameof(Department.Active)" Title="Status" Width="100px" Sortable="true" TextAlign="@ColumnTextAlign.Center">
                <Template>
                    @{
                        var department = (Department)context;
                        var isActive = department.Active ?? true;
                    }
                    <span class="status-badge @(isActive ? "status-active" : "status-inactive")">
                        @(isActive ? "Active" : "Inactive")
                    </span>
                </Template>
                <EditorTemplate>
                    @{
                        var department = (Department)context;
                    }
                    <div class="active-toggle-container">
                        <label class="toggle-label">Department Status:</label>
                        <TelerikSwitch @bind-Value="department.Active"
                                       OnLabel="Active"
                                       OffLabel="Inactive"
                                       Width="100px" />
                    </div>
                </EditorTemplate>
            </GridColumn>

            <GridColumn Field="RecordAdd" Sortable="false" Visible="false" Editable="false" />

            @* Action buttons for each department *@
            <GridCommandColumn Width="300px" Title="Department Admin">
                <GridCommandButton Command="Info"
                                   OnClick="() => ShowDepartmentInfo((Department)context)"
                                   Icon="@CustomIcons.Domain">Info</GridCommandButton>
                <GridCommandButton Command="Edit" Icon="SvgIcon.Pencil">Edit</GridCommandButton>
                <GridCommandButton Command="Save" Icon="SvgIcon.Save" ShowInEdit="true">Save</GridCommandButton>
                <GridCommandButton Command="Cancel" Icon="SvgIcon.Cancel" ShowInEdit="true">Cancel</GridCommandButton>
                <GridCommandButton Command="Delete" Icon="SvgIcon.Trash">Delete</GridCommandButton>
            </GridCommandColumn>
        </GridColumns>
    </TelerikGrid>
</RequireAuth>

<DepartmentCard @ref="DepartmentCardRef" Locations="@locations" />

@if (isLoading)
{
    <p>Loading...</p>
}

<style>
    .grid-text {
        font-family: Roboto;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .employee-table {
        display: grid;
        border-collapse: collapse;
        margin: 25px 0;
        font-size: 0.9em;
        min-width: 400px;
    }

    .k-window-titlebar {
        background-color: var(--kendo-color-primary);
        color: white;
        font-weight: 700;
        font-size: 2em;
        padding: 10px;
        text-align: center;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .employee-table thead tr {
        background-color: var(--kendo-color-primary);
        display: flex;
    }

    .status-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8em;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .status-active {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .status-inactive {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .active-toggle-container {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
        padding: 10px;
    }

    .toggle-label {
        font-weight: 600;
        margin-bottom: 5px;
        color: var(--kendo-color-primary);
        background: transparent !important;
        padding: 0 !important;
        text-transform: none !important;
        font-size: 0.9em;
    }

    .k-popup-edit-form label,
    .k-edit-form-container label {
        white-space: normal !important;
        word-wrap: break-word !important;
        overflow-wrap: break-word !important;
        text-transform: none !important;
        max-width: 100%;
        display: inline-block;
        padding: 4px 6px !important;
        margin-bottom: 8px !important;
        font-size: 0.85em !important;
        line-height: 1.4;
    }

    .toggle-label {
        white-space: nowrap;
        padding: 4px 8px !important;
        background-color: transparent !important;
        color: inherit !important;
        text-transform: none !important;
        font-weight: 500;
    }

    .active-toggle-container {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 0;
    }

    .status-badge {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.85em;
        font-weight: 500;
        display: inline-block;
    }

    .status-active {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .status-inactive {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .k-popup-edit-form .k-form-field,
    .k-edit-form-container .k-form-field {
        overflow: visible;
        margin-bottom: 12px;
    }

    .k-popup-edit-form .k-dropdown,
    .k-edit-form-container .k-dropdown {
        width: 100%;
    }

    .k-checkbox {
        border-color: var(--kendo-color-secondary);
    }

    .k-grid tr.inactive-row {
        opacity: 0.5;
        background-color: #f8f9fa !important;
    }

        .k-grid tr.inactive-row:hover {
            background-color: #e9ecef !important;
        }

        .k-grid tr.inactive-row td {
            color: #6c757d !important;
        }

    .k-grid tr.inactive-row {
        filter: grayscale(60%);
        opacity: 0.6;
    }

        .k-grid tr.inactive-row:hover {
            filter: grayscale(40%);
            opacity: 0.8;
        }
</style>

@code {
    private List<Department> departments { get; set; } = new List<Department>();
    private bool isLoading = true;
    public List<Location> locations { get; set; } = new List<Location>();
    private TelerikWindow? DeptInfoWindow { get; set; }
    private Department? SelectedDepartment { get; set; }
    private bool WindowVisible { get; set; }
    private DepartmentCard DepartmentCardRef { get; set; }

    // Apply CSS class to inactive department rows
    private void OnDepartmentRowRender(GridRowRenderEventArgs args)
    {
        var department = (Department)args.Item;
        var isActive = department.Active ?? true;

        if (!isActive)
        {
            args.Class = "inactive-row";
        }
    }

    private void OpenWindow()
    {
        WindowVisible = true;
    }

    private string GetWindowTitle()
    {
        return SelectedDepartment != null
            ? $"{SelectedDepartment.DeptName} - Details"
            : "Department Information";
    }

    // Show department details modal
    public void ShowDepartmentInfo(Department department)
    {
        DepartmentCardRef.ShowDepartmentInfo(department);
    }

    // Load department and location data from database
    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
        await base.OnInitializedAsync();
    }

    private async Task LoadDataAsync()
    {
        try
        {
            isLoading = true;
            await using var context = await DbContextFactory.CreateDbContextAsync();

            locations = await context.Locations!.ToListAsync();

            departments = await context.Departments!
                .Include(d => d.DeptLocation)
                .OrderBy(d => d.DeptLocation!.LocName)
                .ThenBy(d => d.DeptName)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"An error occurred while loading data: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    // Update existing department
    async Task Update(GridCommandEventArgs args)
    {
        await using var context = await DbContextFactory.CreateDbContextAsync();

        var department = (Department)args.Item;
        var existingDepartment = await context.Departments.FindAsync(department.Id);

        if (existingDepartment != null)
        {
            context.Entry(existingDepartment).CurrentValues.SetValues(department);
            await context.SaveChangesAsync();
        }
    }

    // Add new department
    async Task Add(GridCommandEventArgs args)
    {
        await using var context = await DbContextFactory.CreateDbContextAsync();
        var department = (Department)args.Item;
        department.RecordAdd = DateTime.UtcNow;
        await context.Departments.AddAsync(department);
        await context.SaveChangesAsync();
        departments.Add(department);
    }

    // Delete department
    async Task Delete(GridCommandEventArgs args)
    {
        await using var context = await DbContextFactory.CreateDbContextAsync();

        var department = (Department)args.Item;
        var existingDepartment = await context.Departments.FindAsync(department.Id);

        if (existingDepartment != null)
        {
            context.Departments.Remove(existingDepartment);
            await context.SaveChangesAsync();
            departments.Remove(department);
        }
    }

    // Fields searchable through global search box
    private List<string> SearchableFields = new List<string>
    {
        nameof(Department.DeptName),
        nameof(Department.DeptManager),
        nameof(Department.DeptEmail)
    };
}