@using EmpDir.Core.Services
@inherits LayoutComponentBase
@inject NavigationManager NavManager
@inject ExportData ExportData
@implements IDisposable

<TelerikRootComponent>
    <div class="app-layout-wrapper">
        @* Header with logo, title, and export button *@
        <TelerikAppBar ThemeColor="@ThemeConstants.AppBar.ThemeColor.Primary"
                       Class="appbar-top">
            <AppBarSpacer Size="2em"></AppBarSpacer>

            <AppBarSection>
                <TelerikSvgIcon Icon="@CustomIcons.Waving_Hand"
                                Flip="@IconFlip.Horizontal"
                                Size="@ThemeConstants.SvgIcon.Size.ExtraLarge"></TelerikSvgIcon>
            </AppBarSection>

            <AppBarSection>
                <div class="nav-title">
                    <NavLink href="">McElroy Phone Directory</NavLink>
                </div>
            </AppBarSection>

            <AppBarSpacer />
            <AppBarSpacer />

            <AppBarSection>
                <TelerikButton Icon="@SvgIcon.FileBac"
                               OnClick="ExportJson"
                               FillMode="@Telerik.Blazor.ThemeConstants.Button.FillMode.Outline">
                    Export Data
                </TelerikButton>
            </AppBarSection>
        </TelerikAppBar>

        @* Side navigation menu *@
        <TelerikDrawer Data="@DrawerData"
                       Expanded="false"
                       @bind-SelectedItem="@DrawerSelectedItem"
                       Mode="@DrawerMode.Push"
                       MiniMode="true"
                       Class="mainlayout-drawer nav-item">
            <DrawerContent>
                <main>
                    @Body
                </main>
            </DrawerContent>
        </TelerikDrawer>

        @* Footer with copyright *@
        <TelerikAppBar ThemeColor="@ThemeConstants.AppBar.ThemeColor.Base"
                       Class="appbar-bottom">
            <AppBarSpacer />
            <AppBarSection>
                <div id="copyright">
                    Copyright &copy; @DateTime.Today.Year McElroy Metal Inc. All rights reserved.
                </div>
            </AppBarSection>
            <AppBarSpacer />
        </TelerikAppBar>

        <TelerikMediaQuery Media="(min-width: 641px)" OnChange="@OnMediaQueryChange" />
    </div>
</TelerikRootComponent>

<style>
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow-x: hidden;
    }

    .app-layout-wrapper {
        height: 100vh;
        display: flex;
        flex-direction: column;
    }

    .appbar-top {
        flex-shrink: 0;
        z-index: 1000;
    }

    .mainlayout-drawer {
        flex: 1;
        min-height: 0;
    }

        .mainlayout-drawer .k-drawer-content {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .mainlayout-drawer main {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background-color: #f8f9fa;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }

    .appbar-bottom {
        flex-shrink: 0;
        z-index: 1000;
    }

    .nav-title a, .nav-title a:hover {
        display: flex;
        gap: .2em;
        align-items: start;
        margin: 0;
        padding: 0;
        font-size: 1.75em;
        font-weight: 600;
        text-decoration: none;
        color: inherit;
        padding: 0 20px 0 10px;
        font-family: Montserrat;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    @@media (max-width: 640px) {
        .mainlayout-drawer main {
            padding: 0.5rem;
        }

        .nav-title a, .nav-title a:hover {
            font-size: 1.4em;
        }
    }
</style>

@code {
    // Navigation menu items for drawer sidebar
    private IEnumerable<NavItem> DrawerData { get; set; } = new List<NavItem>()
    {
        new NavItem("Home", CustomIcons.Home, "/", "HOME"),
        new NavItem("Employees", CustomIcons.Face, "/Employees", "EMPLOYEES"),
        new NavItem("Departments", CustomIcons.Domain, "/Departments", "DEPARTMENTS"),
        new NavItem("Locations", CustomIcons.Factory, "/Locations", "LOCATIONS")
    };

    // Export directory data to JSON file
    private async Task ExportJson()
    {
        await ExportData.ExportJsonToFileAsync();
    }

    private bool DrawerExpanded { get; set; } = true;
    private NavItem? DrawerSelectedItem { get; set; }
    private bool LargeScreen { get; set; } = true;
    TooltipPosition position { get; set; } = TooltipPosition.Right;

    // Update drawer state based on screen size
    private void OnMediaQueryChange(bool mediaQueryMatched)
    {
        LargeScreen = DrawerExpanded = mediaQueryMatched;
    }

    // Handle drawer expand/collapse for small screens
    private void DrawerExpandedChanged(bool newExpanded)
    {
        if (!LargeScreen && !newExpanded)
        {
            DrawerExpanded = newExpanded;
        }
    }

    // Set selected drawer item based on current URL
    private void SelectDrawerItem()
    {
        var url = NavManager.Uri.Replace(NavManager.BaseUri, "/").ToLowerInvariant();
        DrawerSelectedItem = DrawerData.FirstOrDefault(x => x.Url.ToLowerInvariant() == url);
    }

    // Update selected menu item when navigation occurs
    private void NavManagerLocationChanged(object? sender, LocationChangedEventArgs args)
    {
        var url = args.Location.Replace(NavManager.BaseUri, "/").ToLowerInvariant();
        DrawerSelectedItem = DrawerData.FirstOrDefault(x => x.Url.ToLowerInvariant() == url);
        InvokeAsync(StateHasChanged);
    }

    // Initialize component and subscribe to navigation events
    protected override void OnInitialized()
    {
        SelectDrawerItem();
        NavManager.LocationChanged += NavManagerLocationChanged;
        base.OnInitialized();
    }

    // Cleanup navigation event subscription
    public void Dispose()
    {
        if (NavManager != null)
        {
            NavManager.LocationChanged -= NavManagerLocationChanged;
        }
    }

    // Navigation menu item model
    public class NavItem
    {
        public string Text { get; set; }
        public ISvgIcon Icon { get; set; }
        public string Url { get; set; } = string.Empty;
        public string Tooltip { get; set; }

        public NavItem(string text, ISvgIcon icon, string url, string tooltip)
        {
            Text = text;
            Icon = icon;
            Url = url;
            Tooltip = tooltip;
        }
    }
}